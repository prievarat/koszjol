<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin – Lesson Check-In</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <main class="max-w-5xl mx-auto p-6">
    <header class="mb-6 flex items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold">Admin – Lesson Check-In</h1>
        <p class="text-sm text-slate-600">Use the controls below to get a snapshot and purge data.</p>
      </div>
      <div class="flex items-center gap-3">
        <div id="qrcode" class="bg-white p-2 rounded-xl shadow"></div>
        <div class="text-xs text-slate-600">
          <div>Student page:</div>
          <a id="studentUrl" class="text-indigo-700 underline" target="_blank" rel="noopener"></a>
        </div>
      </div>
    </header>

    <section class="mb-4 bg-white p-4 rounded-2xl shadow">
      <div class="flex flex-wrap items-center gap-3">
        <button id="btnPreview"
                class="rounded-lg bg-slate-200 px-4 py-2 hover:bg-slate-300">
          Preview count (no purge)
        </button>
        <button id="btnGeneratePurge"
                class="rounded-lg bg-indigo-600 text-white px-4 py-2 hover:bg-indigo-700">
          Generate chart & purge
        </button>
        <button id="btnExport"
                class="rounded-lg bg-emerald-600 text-white px-4 py-2 hover:bg-emerald-700">
          Export CSV (no purge)
        </button>
        <button id="btnExportPurge"
                class="rounded-lg bg-emerald-700 text-white px-4 py-2 hover:bg-emerald-800">
          Export CSV & purge
        </button>
        <button id="btnPurge"
                class="rounded-lg bg-rose-600 text-white px-4 py-2 hover:bg-rose-700">
          Purge now
        </button>
        <span id="status" class="text-sm ml-2"></span>
      </div>
    </section>

    <section class="grid lg:grid-cols-2 gap-6">
      <div class="bg-white p-4 rounded-2xl shadow">
        <h2 class="font-semibold mb-3">Class Averages</h2>
        <canvas id="avgChart" width="400" height="300" class="w-full"></canvas>
        <div class="mt-3 flex gap-3">
          <button id="btnDownloadChart"
                  class="rounded-lg bg-slate-200 px-3 py-1 hover:bg-slate-300 disabled:opacity-50"
                  disabled>Download chart (PNG)</button>
        </div>
      </div>

      <div class="bg-white p-4 rounded-2xl shadow">
        <h2 class="font-semibold mb-3">Submissions (snapshot)</h2>
        <div class="overflow-auto max-h-96">
          <table id="table" class="min-w-full text-sm">
            <thead class="sticky top-0 bg-slate-100">
              <tr>
                <th class="text-left p-2">Time</th>
                <th class="text-left p-2">Name/Nick</th>
                <th class="text-left p-2">Mot</th>
                <th class="text-left p-2">En</th>
                <th class="text-left p-2">Happy</th>
                <th class="text-left p-2">Note</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script>
    // === Basic setup: admin token & student URL / QR ===
    const studentURL = window.location.origin + '/';
    document.getElementById('studentUrl').textContent = studentURL;
    document.getElementById('studentUrl').href = studentURL;
    new QRCode(document.getElementById("qrcode"), {
      text: studentURL, width: 96, height: 96, correctLevel: QRCode.CorrectLevel.M
    });

    let ADMIN_TOKEN = localStorage.getItem('ADMIN_TOKEN') || '';
    async function ensureToken() {
      while (!ADMIN_TOKEN) {
        const inp = prompt('Enter Admin PIN:');
        if (inp && inp.trim().length > 0) {
          ADMIN_TOKEN = inp.trim();
          localStorage.setItem('ADMIN_TOKEN', ADMIN_TOKEN);
        }
      }
    }
    ensureToken();

    const statusEl = document.getElementById('status');
    const tbody = document.getElementById('tbody');
    const btnPreview = document.getElementById('btnPreview');
    const btnGeneratePurge = document.getElementById('btnGeneratePurge');
    const btnPurge = document.getElementById('btnPurge');
    const btnExport = document.getElementById('btnExport');
    const btnExportPurge = document.getElementById('btnExportPurge');
    const btnDownloadChart = document.getElementById('btnDownloadChart');
    const avgCanvas = document.getElementById('avgChart');

    let avgChart;

    function setStatus(msg, ok=true) {
      statusEl.className = ok ? 'text-emerald-700' : 'text-rose-700';
      statusEl.textContent = msg;
    }

    function authHeaders() {
      return { 'x-admin-token': ADMIN_TOKEN };
    }

    function renderTable(rows) {
      tbody.innerHTML = '';
      for (const r of rows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="align-top p-2">${new Date(r.timestamp).toLocaleTimeString()}</td>
          <td class="align-top p-2">${escapeHtml(r.name)}</td>
          <td class="align-top p-2">${r.motivation}</td>
          <td class="align-top p-2">${r.energy}</td>
          <td class="align-top p-2">${r.happiness}</td>
          <td class="align-top p-2">${escapeHtml(r.note || '')}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, c =>
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])
      );
    }

    function renderAvgChart(aggregates) {
      const labels = ['Motivation', 'Energy', 'Happiness'];
      const data = [
        aggregates.averages.motivation || 0,
        aggregates.averages.energy || 0,
        aggregates.averages.happiness || 0
      ];
      if (avgChart) { avgChart.destroy(); }
      avgChart = new Chart(avgCanvas.getContext('2d'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Average (1–10)',
            data
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { suggestedMin: 0, suggestedMax: 10, ticks: { stepSize: 1 } }
          }
        }
      });
      btnDownloadChart.disabled = false;
    }

    btnDownloadChart.addEventListener('click', () => {
      if (!avgChart) return;
      const url = avgChart.toBase64Image('image/png', 1);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'class-averages.png';
      a.click();
    });

    async function fetchStats({ purge=false } = {}) {
      try {
        const url = '/api/stats' + (purge ? '?purge=1' : '');
        const res = await fetch(url, { headers: authHeaders() });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Request failed');

        renderAvgChart(data.aggregates);
        renderTable(data.submissions);

        if (purge) {
          setStatus(`Snapshot received (n=${data.aggregates.count}). Data has been purged from the server.`);
        } else {
          setStatus(`Snapshot received (n=${data.aggregates.count}). Data remains on the server.`);
        }
      } catch (err) {
        setStatus('Error: ' + err.message, false);
      }
    }

    btnPreview.addEventListener('click', () => fetchStats({ purge: false }));
    btnGeneratePurge.addEventListener('click', () => fetchStats({ purge: true }));

    btnPurge.addEventListener('click', async () => {
      try {
        const res = await fetch('/api/purge', { method: 'POST', headers: authHeaders() });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Purge failed');
        setStatus('All data purged.');
        renderTable([]);
        if (avgChart) { avgChart.destroy(); btnDownloadChart.disabled = true; }
      } catch (err) {
        setStatus('Error: ' + err.message, false);
      }
    });

    btnExport.addEventListener('click', async () => {
      await downloadCSV(false);
    });
    btnExportPurge.addEventListener('click', async () => {
      await downloadCSV(true);
    });

    async function downloadCSV(purge) {
      try {
        const url = '/api/export' + (purge ? '?purge=1' : '');
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || 'Export failed');
        }
        const blob = await res.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = purge ? 'checkin_purged.csv' : 'checkin.csv';
        a.click();
        setStatus(purge ? 'CSV downloaded and data purged.' : 'CSV downloaded.');
      } catch (err) {
        setStatus('Error: ' + err.message, false);
      }
    }
  </script>
</body>
</html>
